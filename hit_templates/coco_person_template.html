<html>
  <head>
    <title>Select which direction the person is facing</title>
    <!-- simpleamt depends on these libraries -->
    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>
    <!-- end of required libraries -->
    <script src='//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">

    <style>
      #task-container {
        text-align: center;
      }
      #button-div {
        margin-bottom: 10px;
      }
      #counter {
        margin: 0 10px;
        font-size: 20pt;
        font-weight: bold;
      }
      img {
        height: 400px;
      }
      #direction-annotations-container {
        margin: 20pt;
      }
    </style>

  </head>
  <body>
    <div id="task-container">
      <h2>Which direction is this person facing?</h2>
      <div id='image-container'>
        <canvas id='image-canvas'>
        Your browser does not support canvas...
        </canvas>
      </div>
      <div id="direction-annotations-container">
        <span class="direction-annotation btn btn-default" id="direction-left">Left</span>
        <span class="direction-annotation btn btn-default" id="direction-away">Away from you</span>
        <span class="direction-annotation btn btn-default" id="direction-right">Right</span>
        <span class="direction-annotation btn btn-default" id="direction-towards">Towards you</span>
        <span class="direction-annotation btn btn-default" id="direction-ambiguous">Ambiguous direction</span>
      </div>

      <div id='button-div'>
        <button id='prev-btn' class='btn btn-lg btn-primary' disabled>Back</button>
        <span id='counter'>
          <span class='counter-top'></span> / <span class='counter-bottom'></span>
        </span>
        <button id='next-btn' class='btn btn-lg btn-primary' disabled>Next</button>
      </div>
    </div>

    {% include "simpleamt.html" %}

    <script>
      $(function() {

        // Define some default input.
          var DEFAULT_INPUT = [{"image_id": 196842, "image_url": "http://mscoco.org/images/196842", "annotation": {"area": 3817.67415, "iscrowd": 0, "image_id": 196842, "bbox": [273.14, 82.25, 72.6, 129.68], "category_id": 1, "id": 183022}, "annotation_id": 183022}, {"image_id": 44474, "image_url": "http://mscoco.org/images/44474", "annotation": {"area": 52541.14914999998, "iscrowd": 0, "image_id": 44474, "bbox": [33.42, 11.94, 303.68, 407.76], "category_id": 1, "id": 183024}, "annotation_id": 183024}]

        var input = null;

        var key_to_button_id = {
          "a": "direction-left",
          "w": "direction-away",
          "d": "direction-right",
          "s": "direction-towards",
          "m": "direction-ambiguous"
        };
        var button_id_to_direction = {
          "direction-left": 0,
          "direction-away": 1,
          "direction-right": 2,
          "direction-towards": 3,
          "direction-ambiguous": -2
        };
        var direction_to_button_id = {
          '0': "direction-left",
          '1': "direction-away",
          '2': "direction-right",
          '3': "direction-towards",
          '-2': "direction-ambiguous"
        };

        // Direction of each person, parallel to input.
        var directions = [];

        // Some variables to track state of the HIT.
        var idx = 0;
        var enabled = false;
        var images = [];

        function main() {
          // If this is a HIT on AMT, then replace the default input with the real input.
          input = simpleamt.getInput(DEFAULT_INPUT);

          // Enable the UI if the HIT is not in preview mode.
          if (!simpleamt.isPreview()) {
            enable_hit();
          }

          // Set up the directions.
          _.each(input, function() { directions.push(-1); });

          // Preload all images
          _.each(input, function(task_info) {
            var img = new Image();
            var img_url = task_info['image_url'];
            img.src = img_url;
            images.push(img);
          });

          // Setup keyboard shortcuts
          if (enabled) {
            // Highlight button on keypress so there is some visual feedback,
            // skip on keyup.
            $(document).keypress(function(e) {
              var key = String.fromCharCode(e.which).toLowerCase();
              if (key in key_to_button_id) {
                $('.direction-annotation').removeClass('active');
                $('#' + key_to_button_id[key]).addClass('active');
              }
            });
            $(document).keyup(function(e) {
              var key = String.fromCharCode(e.which).toLowerCase();
              if (key in key_to_button_id) {
                $('#' + key_to_button_id[key]).click();
              } else {
                if (e.which == 39) { // right arrow
                  $('#next-btn').click();
                } else if (e.which == 37) { // left arrow
                  $('#prev-btn').click();
                }
              }
            });
          }

          render();
        }

        // Use the current index to update the image and description
        function render() {
          if (!images[idx].complete) {
            images[idx].onload = function() { render(images); }
            return;
          }

          // Set up the image
          var jCanvas = $('#image-canvas');
          var canvas = jCanvas[0];
          canvas.width = images[idx].width;
          canvas.height = images[idx].height;
          var ctx = canvas.getContext("2d");
          ctx.fillStyle = "red";
          ctx.drawImage(images[idx], 0, 0);

          // Create a mask canvas for the bounding box, so we can highlight
          // the bounding box by darkening the rest of the image.
          var maskCanvas = document.createElement('canvas');
          maskCanvas.width = canvas.width;
          maskCanvas.height = canvas.height;
          var maskCtx = maskCanvas.getContext("2d");

          var boundingBox = input[idx]['annotation']['bbox'];

          var boxX = boundingBox[0],
              boxY = boundingBox[1],
              boxWidth = boundingBox[2],
              boxHeight = boundingBox[3];

          var boundingBoxScalingFactor = 1.3,
              scaledBoxWidth = boxWidth * boundingBoxScalingFactor,
              scaledBoxHeight = boxHeight * boundingBoxScalingFactor,
              scaledBoxX = boxX - (scaledBoxWidth - boxWidth) / 2.0,
              scaledBoxY = boxY - (scaledBoxHeight - boxHeight) / 2.0;

          maskCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
          maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
          maskCtx.fillStyle = 'black';
          maskCtx.globalCompositeOperation = 'xor';
          maskCtx.rect(scaledBoxX, scaledBoxY, scaledBoxWidth, scaledBoxHeight);
          maskCtx.fill();
          ctx.drawImage(maskCanvas, 0, 0);

          jCanvas.css('height', '300px');

          // Refresh the counter
          $('.counter-top').text(idx + 1);
          $('.counter-bottom').text(input.length);

          // If the UI is enabled, enable or disable the buttons depending on
          // the index.
          if (enabled) {
            var prev_btn = $('#prev-btn');
            var next_btn = $('#next-btn');
            prev_btn.prop('disabled', true);
            next_btn.prop('disabled', true);
            if (idx > 0) {
              prev_btn.prop('disabled', false);
            }
            if (idx < input.length - 1) next_btn.prop('disabled', false);
          }
        }

        // Mark the selected button as active.
        $('.direction-annotation').click(function() {
          $('.direction-annotation').removeClass('active');
          $(this).addClass('active');
          set_idx(idx + 1);
        });

        function update_selected_direction() {
          selected_direction_buttons = $('.direction-annotation.active');
          if (selected_direction_buttons.length == 1) {
            selected_direction_id = selected_direction_buttons[0].id;
            directions[idx] = button_id_to_direction[selected_direction_id];
          }
        }

        // Update the index, and save the text in the text area.
        function set_idx(new_idx) {
          if (new_idx < 0 || new_idx >= input.length) return;

          update_selected_direction();
          $('.direction-annotation').removeClass('active');

          idx = new_idx;
          render();
        }

        // Enable the UI.
        function enable_hit() {
          enabled = true;

          // Enable components
          $('#next-btn').click(function() { set_idx(idx + 1) });
          $('#prev-btn').click(function() { set_idx(idx - 1) });
          $('#text-area').prop('disabled', false);
          $('#submit-btn').prop('disabled', false);

          // Set up submit handler.
          simpleamt.setupSubmit();
          $('#submit-btn').click(function() {
            update_selected_direction();
            invalid_directions = _.filter(directions, function(d) { return d == -1; });
            if (invalid_directions.length > 0) {
              alert('Direction for image ' + invalid_directions.join(', ') + ' missing.');
              return false;
            }
            var output = _.map(_.zip(input, directions), function(x) {
              return {'input': x[0], 'direction': x[1]};
            });
            simpleamt.setOutput(output);
          });
        }

        main();
      });
    </script>
  </body>
</html>
